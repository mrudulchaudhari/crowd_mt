{% extends "core/base.html" %}

{% block title %}Scanner — CrowdWatch{% endblock %}

{% block content %}
<div class="scanner-wrap">
  <div class="card scanner-card">
    <div class="scanner-header">
      <div>
        <h2 id="scanner-title">QR / Code Scanner</h2>
        <p class="muted" id="scanner-sub">Paste token or enter numeric event id to check-in.</p>
      </div>

      <div class="meta">
        <span class="badge badge--muted">Scanner</span>
      </div>
    </div>

    <div class="scanner-body">
      <div class="form-block">
        <label for="token_input" class="block text-gray-700 font-semibold mb-2">Token / Event ID</label>
        <input
          type="text"
          id="token_input"
          name="token_input"
          class="input-mono"
          placeholder="Token (e.g. a1b2c3d4e5) or numeric event id"
          autocomplete="off"
          required
        />

        <div class="btn-row">
          <button id="useTokenBtn" type="button" class="btn btn-primary">Scan by token</button>
          {% comment %} <button id="useEventIdBtn" type="button" class="btn btn-secondary">Use as event id</button> {% endcomment %}
        </div>

        <div id="formError" class="muted error hidden"></div>
        <div id="formSuccess" class="muted success hidden"></div>
      </div>

      <div class="result-block">
        <div id="resultCard" class="result-card hidden">
          <h3 id="evtName">Event</h3>
          <p class="muted" id="evtLoc">Location not specified</p>

          <div class="result-meta">
            <div class="meta-item">Headcount: <strong id="evtHeadcount">—</strong></div>
            <div class="meta-item">Event ID: <code id="evtId">—</code></div>
          </div>

          {% comment %} <div class="result-actions">
            <a id="viewDetailsBtn" class="btn-link" href="#">View Event Details</a>
            <button id="incrementBtn" class="btn btn-success">Increment Headcount</button>
          </div> {% endcomment %}
        </div>

        {% comment %} <div id="idleCard" class="idle-card">
          <svg class="idle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 11c1.657 0 3-1.343 3-3S13.657 5 12 5 9 6.343 9 8s1.343 3 3 3zM12 13c-4 0-6 2-6 4v1h12v-1c0-2-2-4-6-4z" />
          </svg>
          <p class="muted">No scan yet. Paste a token or enter numeric id to find the event and update headcount.</p>
        </div> {% endcomment %}
      </div>
    </div>

    <div class="scanner-actions">
      <a class="btn btn-secondary" href="{% url 'core_templates:events_list' %}">← Back to events</a>
      {% comment %} <a class="btn btn-primary" id="open-camera" role="button">Open Camera (QR)</a> {% endcomment %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const tokenInput = document.getElementById('token_input');
  const useTokenBtn = document.getElementById('useTokenBtn');
  const useEventIdBtn = document.getElementById('useEventIdBtn');
  const formError = document.getElementById('formError');
  const formSuccess = document.getElementById('formSuccess');

  const resultCard = document.getElementById('resultCard');
  const idleCard = document.getElementById('idleCard');
  const evtName = document.getElementById('evtName');
  const evtLoc = document.getElementById('evtLoc');
  const evtHeadcount = document.getElementById('evtHeadcount');
  const evtId = document.getElementById('evtId');
  const viewDetailsBtn = document.getElementById('viewDetailsBtn');
  const incrementBtn = document.getElementById('incrementBtn');

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  function showError(msg){ formError.textContent = msg; formError.classList.remove('hidden'); formSuccess.classList.add('hidden'); }
  function showSuccess(msg){ formSuccess.textContent = msg; formSuccess.classList.remove('hidden'); formError.classList.add('hidden'); }

  async function scanByToken(token){
    try{
      const res = await fetch("{% url 'scan_by_token' %}", {
        method: 'POST',
        headers: {'Content-Type':'application/json', 'X-CSRFToken': csrftoken},
        body: JSON.stringify({ token: token, increment: 1 })
      });
      const data = await res.json();
      return data;
    } catch(err){
      console.error(err);
      return { error: 'network' };
    }
  }

  async function scanById(event_id){
    try{
      const res = await fetch("{% url 'scan' %}", {
        method: 'POST',
        headers: {'Content-Type':'application/json', 'X-CSRFToken': csrftoken},
        body: JSON.stringify({ event_id: event_id, increment: 1 })
      });
      const data = await res.json();
      return data;
    } catch(err){
      console.error(err);
      return { error: 'network' };
    }
  }

  useTokenBtn.addEventListener('click', async function(){
    const val = tokenInput.value.trim();
    if (!val){
      showError('Please paste a token.');
      return;
    }
    showSuccess('Scanning...');
    const resp = await scanByToken(val);
    if (resp && resp.headcount !== undefined && resp.event_id !== undefined){
      renderEvent({
        id: resp.event_id,
        name: resp.event_name || `Event ${resp.event_id}`,
        location: resp.event_location || '',
        headcount: resp.headcount,
        token: val
      });
      showSuccess('Checked in successfully');
    } else {
      showError(resp.error || 'Event not found.');
    }
  });

  useEventIdBtn.addEventListener('click', async function(){
    const val = tokenInput.value.trim();
    if (!val){
      showError('Please enter an event id.');
      return;
    }
    const id = parseInt(val, 10);
    if (isNaN(id)){
      showError('Event id should be numeric. For tokens, use Scan by token.');
      return;
    }
    showSuccess('Scanning...');
    const resp = await scanById(id);
    if (resp && resp.headcount !== undefined && resp.event_id !== undefined){
      renderEvent({
        id: resp.event_id,
        name: resp.event_name || `Event ${resp.event_id}`,
        location: resp.event_location || '',
        headcount: resp.headcount
      });
      showSuccess('Checked in successfully');
    } else {
      showError(resp.error || 'Event not found.');
    }
  });

  function renderEvent(ev){
    evtName.textContent = ev.name || 'Event';
    evtLoc.textContent = ev.location || 'Location not specified';
    evtHeadcount.textContent = ev.headcount ?? '—';
    evtId.textContent = ev.id ?? '—';
    viewDetailsBtn.href = ev.detail_url || `/events/${ev.id}/`;
    resultCard.classList.remove('hidden');
    idleCard.classList.add('hidden');
  }

  incrementBtn.addEventListener('click', async function(){
    const id = evtId.textContent;
    if (!id || id === '—') return;
    const resp = await scanById(id);
    if (resp && resp.headcount !== undefined){
      evtHeadcount.textContent = resp.headcount;
      showSuccess('Headcount incremented.');
    } else {
      showError(resp.error || 'Could not increment.');
    }
  });

  // Camera button placeholder: you can wire html5-qrcode later
  document.getElementById('open-camera').addEventListener('click', function(){
    alert('Camera scanner not yet enabled. I can add html5-qrcode page if you want.');
  });
})();
</script>

<style>
/* Scanner page styles modeled after event_detail.css from the app */

.scanner-wrap { max-width: 900px; margin: 0 auto; display: grid; gap: 1.25rem; }

.scanner-card { padding: 1rem; display:flex; flex-direction:column; gap:1rem; }
.scanner-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; }
.scanner-header h2 { margin-bottom: 0.25rem; font-size: 1.4rem; }
.muted { color: #64748b; font-size: 0.95rem; }

.meta { display:flex; align-items:center; gap:0.5rem; }
.badge { padding: 0.35rem 0.6rem; border-radius: 999px; font-weight: 700; font-size: 0.85rem; }
.badge--ok { background:#e6fffa; color:#065f46; }
.badge--warn { background:#fff7ed; color:#92400e; }
.badge--crit { background:#ffeef0; color:#9b1c1c; }
.badge--live { background:#e8f3ff; color:#0f172a; }
.badge--disc { background:#f1f5f9; color:#475569; }
.badge--muted { background:#eef2ff; color:#334155; }

/* Form and controls */
.scanner-body { display:grid; grid-template-columns: 1fr 1fr; gap: 1rem; align-items:start; }
.form-block { display:flex; flex-direction:column; gap:0.75rem; }
.input-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace; padding: .6rem .75rem; border-radius: 8px; border: 1px solid #e6edf2; font-size: 1rem; }
.btn-row { display:flex; gap:0.5rem; margin-top: 0.25rem; }
.btn { display:inline-flex; align-items:center; justify-content:center; gap:0.5rem; padding:0.5rem 0.75rem; border-radius: 8px; font-weight:600; text-decoration:none; cursor:pointer; border: 1px solid transparent; }
.btn-primary { background:#2563eb; color:#fff; border-color: rgba(37,99,235,0.9); }
.btn-secondary { background:#f1f5f9; color:#0f172a; border-color: #e2e8f0; }
.btn-success { background:#16a34a; color:#fff; border-color: rgba(22,163,74,0.9); }
.btn-link { background:transparent; color:#2563eb; border:none; padding:0; font-weight:600; text-decoration:underline; }

/* Result */
.result-block { display:flex; align-items:center; justify-content:center; min-height:160px; }
.result-card { width:100%; }
.result-card h3 { margin:0 0 .2rem 0; font-size:1.1rem; }
.result-meta { display:flex; gap:1rem; margin:0.6rem 0; }
.meta-item { background:#f8fafc; padding:0.35rem 0.6rem; border-radius:8px; font-size:0.95rem; }

/* Idle */
.idle-card { text-align:center; color:#64748b; }
.idle-icon { width:48px; height:48px; stroke:#cbd5e1; margin-bottom:0.5rem; }

/* Actions */
.scanner-actions { display:flex; gap: .75rem; margin-top: 1rem; }

/* Utility */
.hidden { display:none !important; }
.error { color:#9b1c1c; }
.success { color:#065f46; }

/* Pulse animation used elsewhere */
.pulse { animation: pulse-change 0.6s ease; }
@keyframes pulse-change {
  0% { transform: scale(1); background: rgba(34,197,94,0); }
  30% { transform: scale(1.06); background: rgba(34,197,94,0.12); }
  100% { transform: scale(1); background: transparent; }
}

/* Responsive */
@media (max-width: 900px) {
  .scanner-body { grid-template-columns: 1fr; }
  .scanner-card { padding: .75rem; }
}
</style>
{% endblock %}
